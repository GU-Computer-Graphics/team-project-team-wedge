<!DOCTYPE html>
<html lang="en">

<head>
    <title></title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            margin: 0;
        }
    </style>
</head>

<body>
    <div id="container"></div>

    <script src="./js/ammo.js"></script>
    <script src="./js/three.js"></script>
    <script src="./js/stats.js"></script>
    <script src="./js/OrbitControls.js"></script>
    <script>

        let camera, scene, renderer;
        Ammo().then((Ammo) => init(Ammo));

        const container = document.getElementById("container");
        const syncList = [];
        let transformAux1;

        const dynamicObjects = [];
        const materialDynamic = new THREE.MeshPhongMaterial({ color: 0xfca400 });
        const materialStatic = new THREE.MeshPhongMaterial({ color: 0x999999 });
        var clock = new THREE.Clock();

        function createRigidObject(pos, quat, params, mass, friction, isBox = false, color = 0xffffff) {
            const material = mass > 0 ? materialDynamic : materialStatic;
            let shape, geometry;
            if (isBox) {
                const w = params.width;
                const l = params.length;
                const h = params.height;
                shape = new THREE.BoxGeometry(w, l, h, 1, 1, 1);
                geometry = new Ammo.btBoxShape(new Ammo.btVector3(w * 0.5, l * 0.5, h * 0.5));
            } else {
                const radius = params.radius;
                const height = params.height;
                shape = new THREE.CylinderGeometry(radius, radius, height, 100, 1);
                geometry = new Ammo.btCylinderShape(new Ammo.btVector3(radius, height * 0.5, radius));
            }
            if (!mass) mass = 0;
            if (!friction) friction = 1;

            const mesh = new THREE.Mesh(shape, new THREE.MeshPhongMaterial({ color }));
            mesh.position.copy(pos);
            mesh.quaternion.copy(quat);
            scene.add(mesh);

            const transform = new Ammo.btTransform();
            transform.setIdentity();
            transform.setOrigin(new Ammo.btVector3(pos.x, pos.y, pos.z));
            transform.setRotation(new Ammo.btQuaternion(quat.x, quat.y, quat.z, quat.w));

            const motionState = new Ammo.btDefaultMotionState(transform);
            const localInertia = new Ammo.btVector3(0, 0, 0);
            geometry.calculateLocalInertia(mass, localInertia);

            const rbInfo = new Ammo.btRigidBodyConstructionInfo(mass, motionState, geometry, localInertia);
            const body = new Ammo.btRigidBody(rbInfo);

            body.setFriction(friction);
            body.setRestitution(.9);
            body.setDamping(0.2, 0.2);

            physicsWorld.addRigidBody(body);

            if (mass > 0) {
                body.setActivationState(DISABLE_DEACTIVATION);

                function sync(dt) {
                    const ms = body.getMotionState();
                    if (ms) {
                        ms.getWorldTransform(TRANSFORM_AUX);
                        const p = TRANSFORM_AUX.getOrigin();
                        const q = TRANSFORM_AUX.getRotation();
                        mesh.position.set(p.x(), p.y(), p.z());
                        mesh.quaternion.set(q.x(), q.y(), q.z(), q.w());
                    }
                }

                syncList.push(sync);
            }
        }



        function init(Ammo) {
            transformAux1 = new Ammo.btTransform();

            function initPhysics() {
                collisionConfiguration = new Ammo.btDefaultCollisionConfiguration();
                dispatcher = new Ammo.btCollisionDispatcher(collisionConfiguration);
                broadphase = new Ammo.btDbvtBroadphase();
                solver = new Ammo.btSequentialImpulseConstraintSolver();
                physicsWorld = new Ammo.btDiscreteDynamicsWorld(dispatcher, broadphase, solver, collisionConfiguration);
                physicsWorld.setGravity(new Ammo.btVector3(0, -9.82, 0));
            }

            function update() {
                renderer.render(scene, camera);
                requestAnimationFrame(update);
            }
            function createObjectMaterial() {
                var c = Math.floor(Math.random() * (1 << 24));
                return new THREE.MeshPhongMaterial({ color: c });
            }


            initPhysics();


            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.02, 2000);
            scene = new THREE.Scene();

            camera.position.x = -3;
            camera.position.y = 2;
            camera.position.z = 2;

            const controls = new THREE.OrbitControls(camera);
            controls.update(0.1);

            const ambientLight = new THREE.AmbientLight(0x704040);
            scene.add(ambientLight);

            renderer = new THREE.WebGLRenderer();
            renderer.setClearColor(0xbfd1e5);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            renderer.render(scene, camera);

            container.appendChild(renderer.domElement);

            const ZERO_QUATERNION = new THREE.Quaternion(0, 0, 0, 1);
            createRigidObject(new THREE.Vector3(0, 0, 0), ZERO_QUATERNION, {height: 20, radius: 21}, 0, 2);
            createRigidObject(new THREE.Vector3(0, 0, 20), ZERO_QUATERNION, {height: 40, width: 42, length: 20}, 0, 2, true);
            createRigidObject(new THREE.Vector3(0, 0, 40), ZERO_QUATERNION, {height: 20, radius: 21}, 0, 2);
            
            
            createRigidObject(new THREE.Vector3(0, 10, 0), ZERO_QUATERNION, {height: 10, radius: 13}, 0, 2, false, 0xff0000);
            createRigidObject(new THREE.Vector3(0, 10, 20), ZERO_QUATERNION, {height: 40, width: 26, length: 10}, 0, 2, true, 0xff0000);
            createRigidObject(new THREE.Vector3(0, 10, 40), ZERO_QUATERNION, {height: 10, radius: 13}, 0, 2, false, 0xff0000);


            update();
        }



    </script>
</body>

</html>